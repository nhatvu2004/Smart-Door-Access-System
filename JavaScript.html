<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.0/js/bootstrap.bundle.min.js"></script> 
<script src="https://cdn.datatables.net/1.13.3/js/jquery.dataTables.min.js"></script> 
<script src="https://cdn.datatables.net/1.13.3/js/dataTables.bootstrap5.min.js"></script> 
<script src="https://cdn.datatables.net/responsive/2.4.0/js/dataTables.responsive.min.js"></script> 
<script src="https://cdn.datatables.net/responsive/2.4.0/js/responsive.bootstrap5.min.js"></script>

<script>
/**
 * Prevent forms from submitting.
 */
function preventFormSubmit() {
    var forms = document.querySelectorAll('form');
    for (var i = 0; i < forms.length; i++) {
        forms[i].addEventListener('submit', function(event) {
            event.preventDefault();
        });
    }
}

window.addEventListener("load", functionInit, true);
window.addEventListener("beforeunload", falseState, true);

/**
 * INITIALIZE FUNCTIONS ONLOAD
 */
function functionInit() {
    $('#spinnerModal').modal('show');
    preventFormSubmit();
    getAllData();
    createCityDropdown();
}

/**
 * HANDLE FORM SUBMISSION
 */
function handleFormSubmit(formObject) {
    $('#spinnerModal').modal('show');
    google.script.run.withSuccessHandler(createTable).processForm(formObject);
    setTimeout(function() {
        $('#myModal').modal('hide');
    }, 2000);
    document.getElementById("message").innerHTML = "<div class='alert alert-warning' role='alert'>Dữ liệu được thêm thành công!.</div>";
    document.getElementById("myForm").reset();
    // Xóa dòng ẩn cột ID
}

/**
 * REFRESH APP
 */
function refreshApp(newHtml) {
    $('#spinnerModal').modal('show');
    falseState();
    document.open();
    document.write(newHtml);
    document.close();
    $('#myModal').modal('hide');
}

/**
 * CLEAR TABLE STATE
 */
function falseState() {
    var dtTable = $('#dataTable').DataTable();
    dtTable.state.clear();
    dtTable.destroy();

    var attTable = $('#attendanceTable').DataTable();
    attTable.state.clear();
    attTable.destroy();
}

/**
 * CLEAR FORM WHEN POP-UP IS CLOSED
 */
function clearForm() {
    document.getElementById("message").innerHTML = "";
    document.getElementById("myForm").reset();
    document.getElementById('RecId').value = ''; // Xóa ID khi đóng form
}

/**
 * GET ALL DATA FROM "Data" SHEET
 */
function getAllData() {
    google.script.run.withSuccessHandler(createTable).getAllData();
}

/**
 * GET ALL DATA FROM "Attendance" SHEET
 */
function getAttendanceData() {
    google.script.run.withSuccessHandler(createAttendanceTable).getAttendanceData();
}

/**
 * CREATE THE DATA TABLE FOR "Data" SHEET
 */
function createTable(dataArray) {
    $('#spinnerModal').modal('hide');
    if (dataArray) {
        var result = "<div>" +
            "<table class='table table-sm' style='font-size:1em'>" +
            "<thead style='white-space: nowrap'>" +
            "<tr>" +
            "<th scope='col'>ID</th>" +
            "<th scope='col'>Họ và Tên</th>" +
            "<th scope='col'>Email</th>" +
            "<th scope='col'>Điện thoại</th>" +
            "<th scope='col'>Chức vụ</th>" +
            "<th scope='col'>Năm sinh</th>" +
            "<th scope='col'>Thành phố</th>" +
            "<th scope='col'>Ngày cập nhật</th>" +
            "<th scope='col'>Edit</th>" +
            "<th scope='col'>Delete</th>" +
            "</tr>" +
            "</thead>";
        for (var i = 0; i < dataArray.length; i++) {
            result += "<tr>";
            for (var j = 0; j < dataArray[i].length; j++) {
                result += "<td>" + dataArray[i][j] + "</td>";
            }
            result += "<td><i style='color: orange' class='fa fa-duotone fa-pen-to-square' data-bs-toggle='modal' data-bs-target='#myModal' onclick='editData(this);'></td>";
            result += "<td><i style='color: red' class='fa fa-sharp fa-solid fa-trash' onclick='deleteData(this);'></td>";
            result += "</tr>";
        }
        result += "</table></div>";
        var div = document.getElementById('dataTable');
        div.innerHTML = result;
        $(document).ready(function() {
            $('#dataTable').DataTable({
                destroy: true,
                responsive: true,
                select: true,
                stateSave: true,
                ordering: true,
                order: [[0, 'desc']],
                pageLength: 5,
                lengthMenu: [
                    [5, 10, 25, 50, 100, -1],
                    ['5', '10', '25', '50', '100', 'All']
                ],
                columnDefs: [
                    {
                        targets: [1, 8, 9], // Chỉ giữ các cột "Họ và Tên", "Edit", "Delete" luôn hiển thị
                        className: 'all',
                    },
                    {
                        targets: [3],
                        className: 'dt-body-center',
                        "render": function(data, type, row, meta) {
                            if (type === 'display' && data.length > 5) {
                                data = row[3] + ' ' + '<i class="fa-brands fa-whatsapp" style="font-size:20px;color: green"></i>';
                            }
                            return data;
                        }
                    }
                ]
            });
        });
    }
}

/**
 * CREATE THE DATA TABLE FOR "Attendance" SHEET
 */
function createAttendanceTable(dataArray) {
    $('#spinnerModal').modal('hide');
    if (dataArray) {
        var result = "<div>" +
            "<table class='table table-sm' style='font-size:1em'>" +
            "<thead style='white-space: nowrap'>" +
            "<tr>" +
            "<th scope='col'>UID</th>" +
            "<th scope='col'>Họ và Tên</th>" +
            "<th scope='col'>Chức vụ</th>" +
            "<th scope='col'>Ngày</th>" +
            "<th scope='col'>Giờ ra</th>" +
            "<th scope='col'>Giờ vào</th>" +
            "</tr>" +
            "</thead>";
        for (var i = 0; i < dataArray.length; i++) {
            result += "<tr>";
            for (var j = 0; j < dataArray[i].length; j++) {
                result += "<td>" + dataArray[i][j] + "</td>";
            }
            result += "</tr>";
        }
        result += "</table></div>";
        var div = document.getElementById('attendanceTable');
        div.innerHTML = result;
        $(document).ready(function() {
            $('#attendanceTable').DataTable({
                destroy: true,
                responsive: true,
                select: true,
                stateSave: true,
                ordering: true,
                order: [[0, 'desc']],
                pageLength: 5,
                lengthMenu: [
                    [5, 10, 25, 50, 100, -1],
                    ['5', '10', '25', '50', '100', 'All']
                ],
                columnDefs: [{
                    targets: [0, 1],
                    className: 'all',
                }]
            });
        });
    }
}

/**
 * TOGGLE TO ATTENDANCE TABLE
 */
function toggleAttendance() {
    var dataTableContainer = document.getElementById('dataTableContainer');
    var attendanceTableContainer = document.getElementById('attendanceTableContainer');

    if (attendanceTableContainer.style.display === 'none') {
        dataTableContainer.style.display = 'none';
        attendanceTableContainer.style.display = 'block';
        $('#spinnerModal').modal('show');
        getAttendanceData();
    }
}

/**
 * TOGGLE BACK TO DATA TABLE
 */
function toggleData() {
    var dataTableContainer = document.getElementById('dataTableContainer');
    var attendanceTableContainer = document.getElementById('attendanceTableContainer');

    if (dataTableContainer.style.display === 'none') {
        attendanceTableContainer.style.display = 'none';
        dataTableContainer.style.display = 'block';
        $('#spinnerModal').modal('show');
        getAllData();
    } else {
        getLatestId();
    }
}

/**
 * DELETE DATA
 */
function deleteData(el) {
    var table = $('#dataTable').DataTable();
    var row = $(el).closest('tr');
    var recordId = table.cell(row, 0).data();

    Swal.fire({
        title: 'Bạn có chắc xóa không?',
        icon: 'warning',
        html: `<input type="password" id="password" class="swal2-input" placeholder="Điền mật khẩu!">`,
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        cancelButtonText: 'Hủy',
        confirmButtonText: 'OK, Xóa dữ liệu này!',
        allowOutsideClick: false,
        preConfirm: () => {
            var pass = "123";
            var password = Swal.getPopup().querySelector('#password').value;
            if (password == pass) {
                return google.script.run
                    .withSuccessHandler(function(data) {
                        createTable(data);
                        Swal.fire('Chúc mừng!', 'Dữ liệu xóa thành công!', 'success');
                    })
                    .withFailureHandler(function(error) {
                        Swal.fire('Lỗi!', 'Không thể xóa: ' + error, 'error');
                    })
                    .deleteData(recordId);
            } else {
                Swal.showValidationMessage('Mật khẩu không hợp lệ!');
            }
        },
    }).then((result) => {
        if (!result.isConfirmed) {
            Swal.fire('Đã hủy!', 'Đã hủy xóa tệp này:)', 'error');
        }
    });
}

/**
 * RETRIEVE DATA FROM GOOGLE SHEET FOR CITY DROPDOWN
 */
function createCityDropdown() {
    google.script.run.withSuccessHandler(cityDropDown).getDropdownListCity("City!A1:A");
}

/**
 * POPULATE CITY DROPDOWNS
 */
function cityDropDown(values) {
    var list = document.getElementById('city');
    for (var i = 0; i < values.length; i++) {
        var option = document.createElement("option");
        option.value = values[i];
        option.text = values[i];
        list.appendChild(option);
    }
}

/** 
 * EDIT DATA
 */
function editData(el) {
    var table = $('#dataTable').DataTable();
    var row = $(el).closest('tr');
    var recordId = table.cell(row, 0).data();
    google.script.run.withSuccessHandler(populateForm).getRecordById(recordId);
}

/** 
 * POPULATE FORM
 */
function populateForm(records) {
    document.getElementById('RecId').value = records[0][0];
    document.getElementById('name').value = records[0][1];
    document.getElementById('email').value = records[0][2];
    document.getElementById('telp').value = records[0][3];
    document.getElementById('position').value = records[0][4];
    document.getElementById('birthday').value = records[0][5];
    document.getElementById('city').value = records[0][6];
    document.getElementById("message").innerHTML = "<div class='alert alert-warning' role='alert'>Update [ID: " + records[0][0] + "]</div>";
}

/**
 * GET LATEST ID FROM SHEET BEFORE OPENING FORM
 */
function getLatestId() {
    google.script.run
        .withSuccessHandler(function(id) {
            document.getElementById('RecId').value = id || '';
            $('#myModal').modal('show');
        })
        .withFailureHandler(function(error) {
            Swal.fire('Lỗi!', 'Không thể đọc ID: ' + error, 'error');
            $('#myModal').modal('show');
        })
        .getLatestIdFromSheet();
}
</script>